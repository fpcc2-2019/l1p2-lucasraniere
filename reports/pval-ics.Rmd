---
title: "P-valores x ICs"
author: "Lucas Raniere Juvino Santos"
output:
  html_document:
    df_print: paged
    theme: readable
    toc: yes
  html_notebook:
    fig_width: 7
    theme: readable
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE, message=FALSE}
library(tidyverse)
library(here)
library(lubridate)
theme_set(theme_bw())

options(readr.num_columns = 0)
```


## O Problema

Considerando que os dados da wikimedia que usamos no Laboratório 2, faça uma inferência sobre como é, na população de todas as sessões do site:

    1. A diferença entre o clickthrough rate dos grupos A e B; e
    2. A diferença na proporção buscas com zero resultados nos grupos A e B
    
## O que precisa ser feito

Você deve produzir, para os pontos 1 e 2 acima:

    a. Um parágrafo de resposta contendo os números necessários e explicando a sua resposta usando testes de hipótese via pemutação. O parágrafo deve ser estilo o que você colocaria em um artigo - claro, formal e contendo as estatísticas e termos necessários (p-valor, se foram usadas permutações, qual era a estatística do teste, etc.).
    b. Um parágrafo de resposta contendo os números necessários e explicando a sua resposta usando ICs. O parágrafo deve ser estilo o que você colocaria em um artigo - claro, formal e contendo as estatísticas e termos necessários (nível de confiança, limites do IC, etc.).
    c. Um parágrafo que comenta se/como os pontos a e b acima concordam, e que compara os dois parágrafos em termos de informação e utilidade para alguém tomando decisões na wikimedia.


## Os dados

```{r echo=FALSE}
buscas = read_csv(here::here("data/search_data.csv"))

glimpse(buscas)
```

## A diferença entre o clickthrough rate dos grupos A e B:

Calculando a diferença do clickthrough rate de cada grupo (função $\theta$):

```{r}

theta_ct <- function(df, i) {

return(abs(diff(pull(
        df %>%
          slice(i) %>% #mudei aqui
          group_by(session_id, group) %>%
          summarise(c_clicks = any(num_clicks > 0)) %>%
          group_by(group) %>%
          summarise(clickt_rate = sum(c_clicks) / n())))))
}

#bootstrap <- function(df) {
#  df <- df %>%
#    group_by(session_id,group) %>%
#    summarise(c_clicks = any(num_clicks > 0)) %>%
#    group_by(group) %>%
#    select(group, c_clicks)
#  boot_df <- sample_n(df,
#                      size = NROW(df),
#                      replace = TRUE)
#  
#  diferenc <- boot_df %>%
#    group_by(group) %>%
#    summarise(click_rate = sum(c_clicks) / n())
#  
#  diferenc <- abs(diff(pull(diferenc))) 

#  return(diferenc)
#}
```

```{r}

theta_c = theta_ct(buscas, 1:NROW(buscas))

```


Calculando a diferença da proporção de buscas com zeros resultados de cada grupo ($\theta$):

```{r}
buscas %>%
  filter(!is.na(results)) %>%
  mutate(t_results = results > 0) %>%
  group_by(group) %>%
  summarise(rate = 1 - (sum(t_results) / n()))
```

